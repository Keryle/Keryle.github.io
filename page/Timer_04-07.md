---
layout: default
title: Timer
description: 定时器的使用
---

# 定时器组成结构

* 定时器T0，T1：由两个特殊功能寄存器TOMD，TCON（TR）；16位加法计数器TH，TL。
* 定时器T2：由特殊功能寄存器TH2,TL2,RCAP2H,RCAP2L组成。

# 控制树

### 定时器T0，T1

TOMD——>TH/TL——>TR——>TX1/TX0——>EA——>中断  

EA，TX,TMOD一般写入主函数，在程序中首先配置好，不经常改变。TH/TL，TR会写入中断函数中，每次重新赋予初始值。窜连控制结构，在程序书写中原则上不分先后次序，但需要注意的是TR是定时开启控制位，一般放在最后书写。分层控制结构虽然琐碎，却也巧妙，提供了灵活的操作空间。

### 定时器T2



# 定时器T0，T1使用：

## IE、IP

EA是总中断开关，置1开启。ET定时器控制开关置1开启，PT置1为高优先级。

## TMOD

| 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
| - | - | - | - | - | - | - | - |
|GATE | C/T | M1 | M0 | GATE | C/T | M1 | M0 |

T0/T1模式选择：

* 不可位寻址，复位值：00H，高四位控制T1，低四位控制T0
* GATE：门控位，当GATE=1，需要INT0/INT1引脚置1才可开启定时计数器
* C/T：置1为计数器，置0为计数器
* M1、M0：定时器/计数器模式选择
    1. 0 0：13位定时器/计数器，2^13=8192，定时最大值8.19ms
    2. 0 1：16位定时器/计数器，2^16=65536 ，定时最大值65.5ms
    3. 1 0：8位自动重装载定时器，2^8=256，定时最大值0.256ms
    4. 1 1：T1无效，定时器0此时作为双8位定时器/计数器。
            TL0作为一个8位定时器/计数器，通过标准定时器0的控制位控制。
            TH0仅作为一个 8位定时器,由定时器1的控制位控制。

## TH、TL

T0的初始值TH0,TL0. T1的初始值TH1,TL1。在模式0或1时，需要进入中断后程序赋初值，在模式2或3时，自动重装载初始值。

## TCON

定时器/计数器控制寄存器。它的的低4位控制外部中断，高4位中软件能操作只有TR0,TR1，他们分别控制T0和T1，当TR0/TR1=1时，定时计数器启动，开始工作。TR置位一般是启动定时器的最后一步。

# 定时器T2的使用

## T2CON

| 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
| - | - | - | - | - | - | - | - |
|TF2 |EXF2 | RCLK | TCLK | EXEN2 | TR2 | C/T2 | CP/RL2 |

* TF2 ：定时器2溢出标志。定时器2溢出时置位，必须由软件清除。当RCLK或TCLK=1 时，TF2 将不会置位。

* EXF2 ：定时器2外部标志。当EXEN2=1且T2EX的负跳变产生捕获或重装时，EXF2置位。定时器2 中断使能时，EXF2=1将使CPU从中断向量处执行定时器2 中断子程序。EXF2位必须用软件清零。在递增/递减计数器模式（DCEN=1）中，EXF2不会引起中断.

* RCLK ：接收时钟标志。RCLK置位时，定时器2的溢出脉冲作为串行口模式1和模式3的接收时钟。RCLK=0时，将定时器1的溢出脉冲作为接收时钟。

* TCLK ：发送时钟标志。TCLK置位时，定时器2的溢出脉冲作为串行口模式1和模式3的发送时钟。TCLK=0时，将定时器1的溢出脉冲作为发送时钟

* EXEN2：定时器2外部使能标志。当其置位且定时器2未作为串行口时钟时，允许T2EX的负跳变产生捕获或重装。EXEN2=0 时，T2EX的跳变对定时器2无效

* TR2 ：定时器2启动/停止控制位。置1时启动定时器

* C/T2 ：定时器/ 计数器选择。（定时器2）
  0 = 内部定时器（OSC/12 或OSC/6）
  1 = 外部事件计数器（下降沿触发）
  
* CP/RL2 ：捕获/ 重装标志。置位：EXEN2=1 时，T2EX 的负跳变产生捕获。清零：EXEN2=0时，定时器2溢出或T2EX 的负跳变都可使定时器自动重装。当RCLK=1 或TCLK=1时，该位无效且定时器强制为溢出时自动重装.
